<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>环境检测</title>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f0f0f0; }
    #result { white-space: pre-wrap; background: #fff; padding: 1em; border-radius: 8px; box-shadow: 0 0 10px #ccc; }
  </style>
</head>
<body>
  <h1>Environment Detection 浏览器环境检测</h1>
  <div id="result">正在检测中...</div>

  <script>
    // ✅ 语言检测表（简化版）
const testCases = [
  {
    language: "zh-Hans",
    name: "简体中文",
    fonts: ["SimSun", "Microsoft YaHei", "PingFang SC"],
    text: "龘麤纛鸂鶒齉鱻",
    likelyCountries: ["CN", "SG", "MY"]
  },
  {
    language: "zh-Hant",
    name: "繁體中文",
    fonts: ["PingFang TC", "Songti TC", "Heiti TC", "PMingLiU", "MingLiU"],
    text: "「龜龘」齉鱻、龗齾！",
    likelyCountries: ["TW", "HK", "MO"]
  },
  {
    language: "ja",
    name: "日文",
    fonts: ["Yu Gothic", "Meiryo", "MS PGothic"],
    text: "あいうえおカキクケコサシスセソ",
    likelyCountries: ["JP"]
  },
  {
    language: "ko",
    name: "韩文",
    fonts: ["Malgun Gothic", "Dotum", "Gulim"],
    text: "한글입니다 가나다라 마바사아자차카타파하",
    likelyCountries: ["KR"]
  },
  {
    language: "en",
    name: "英文",
    fonts: ["Arial", "Times New Roman", "Tahoma"],
    text: "The quick brown fox jumps over the lazy dog",
    likelyCountries: ["US", "GB", "CA", "AU", "NZ", "IN", "ZA"]
  },
  {
    language: "fr",
    name: "法语",
    fonts: ["Arial", "Verdana", "Georgia"],
    text: "Éléphant à l’école mange du gâteau",
    likelyCountries: ["FR", "BE", "CA", "CH", "LU", "SN", "MG"]
  },
  {
    language: "de",
    name: "德语",
    fonts: ["Arial", "Tahoma", "Times New Roman"],
    text: "Fünf große Bücher über österreichische Ästhetik",
    likelyCountries: ["DE", "AT", "CH", "LI"]
  },
  {
    language: "es",
    name: "西班牙语",
    fonts: ["Arial", "Verdana", "Georgia"],
    text: "El pingüino comió ñoquis en el jardín",
    likelyCountries: ["ES", "MX", "AR", "CO", "CL", "PE"]
  },
  {
    language: "pt",
    name: "葡萄牙语",
    fonts: ["Arial", "Times New Roman", "Tahoma"],
    text: "O coração do João está cheio de emoção",
    likelyCountries: ["PT", "BR", "AO", "MZ"]
  },
  {
    language: "it",
    name: "意大利语",
    fonts: ["Arial", "Georgia", "Verdana"],
    text: "L’aquila vola sopra il lago tranquillo",
    likelyCountries: ["IT", "CH", "SM"]
  },
  {
    language: "ru",
    name: "俄语",
    fonts: ["Arial", "Times New Roman", "Georgia"],
    text: "Привет мир Ж Ц Щ Ы Э Ю Я",
    likelyCountries: ["RU", "BY", "KZ", "KG", "UA"]
  },
  {
    language: "uk",
    name: "乌克兰语",
    fonts: ["Arial", "Georgia", "Tahoma"],
    text: "Їжак їв яблуко біля ялинки",
    likelyCountries: ["UA"]
  },
  {
    language: "pl",
    name: "波兰语",
    fonts: ["Arial", "Verdana", "Georgia"],
    text: "Zażółć gęślą jaźń wśród źdźbeł",
    likelyCountries: ["PL"]
  },
  {
    language: "cs",
    name: "捷克语",
    fonts: ["Arial", "Tahoma", "Times New Roman"],
    text: "Příliš žluťoučký kůň úpěl ďábelské ódy",
    likelyCountries: ["CZ"]
  },
  {
    language: "ro",
    name: "罗马尼亚语",
    fonts: ["Arial", "Georgia", "Verdana"],
    text: "Îți văd zâmbetul în zori de zi",
    likelyCountries: ["RO", "MD"]
  },
  {
    language: "hu",
    name: "匈牙利语",
    fonts: ["Arial", "Tahoma", "Georgia"],
    text: "Árvíztűrő tükörfúrógép",
    likelyCountries: ["HU"]
  },
  {
    language: "tr",
    name: "土耳其语",
    fonts: ["Arial", "Verdana", "Georgia"],
    text: "Pijamalı hasta yağız şoföre çabucak güvendi",
    likelyCountries: ["TR", "CY"]
  },
  {
    language: "el",
    name: "希腊语",
    fonts: ["Arial", "Times New Roman", "Georgia"],
    text: "Η γρήγορη αλεπού πήδηξε πάνω από τον τεμπέλη σκύλο",
    likelyCountries: ["GR", "CY"]
  },
  {
    language: "sv",
    name: "瑞典语",
    fonts: ["Arial", "Tahoma", "Georgia"],
    text: "Yxskaftbud, ge vår WC-zonmö IQ-hjälp",
    likelyCountries: ["SE", "FI"]
  },
  {
    language: "da",
    name: "丹麦语",
    fonts: ["Arial", "Verdana", "Georgia"],
    text: "Høj bly gom vandt fræk sexquiz",
    likelyCountries: ["DK"]
  },
  {
    language: "fi",
    name: "芬兰语",
    fonts: ["Arial", "Tahoma", "Georgia"],
    text: "Törkylempijävongahdus",
    likelyCountries: ["FI"]
  },
  {
    language: "no",
    name: "挪威语",
    fonts: ["Arial", "Verdana", "Georgia"],
    text: "Blåbærsyltetøy på fjelltoppen",
    likelyCountries: ["NO"]
  },
  {
    language: "nl",
    name: "荷兰语",
    fonts: ["Arial", "Georgia", "Verdana"],
    text: "Pa’s wijze lynx bezag vroom het fikse aquaduct",
    likelyCountries: ["NL", "BE", "SR"]
  },
  {
    language: "he",
    name: "希伯来语",
    fonts: ["Arial Hebrew", "FrankRuehl", "David", "Noto Sans Hebrew"],
    text: "שָׁלוֹם עוֹלָם אֵיךְ אַתָּה מַרְגִּישׁ הַיּוֹם",
    likelyCountries: ["IL"]
  },
  {
    language: "ar",
    name: "阿拉伯语",
    fonts: ["Amiri", "Scheherazade", "Arial"],
    text: "السلام عليكم كيف حالك اليوم",
    likelyCountries: ["SA", "EG", "AE", "DZ", "MA", "IQ", "JO", "LB", "SY", "SD"]
  },
  {
    language: "fa",
    name: "波斯语",
    fonts: ["B Nazanin", "Tahoma", "Arial"],
    text: "سلام دنیا حال شما چطور است",
    likelyCountries: ["IR", "AF", "TJ"]
  },
  {
    language: "hi",
    name: "印地语",
    fonts: ["Mangal", "Noto Sans Devanagari", "Arial"],
    text: "नमस्ते दुनिया आप कैसे हैं",
    likelyCountries: ["IN", "FJ", "MU"]
  },
  {
    language: "bn",
    name: "孟加拉语",
    fonts: ["SolaimanLipi", "Noto Sans Bengali", "Arial"],
    text: "হ্যালো বিশ্ব আপনি কেমন আছেন",
    likelyCountries: ["BD", "IN"]
  },
  {
    language: "ta",
    name: "泰米尔语",
    fonts: ["Latha", "Noto Sans Tamil", "Arial"],
    text: "வணக்கம் உலகம் நீங்கள் எப்படி இருக்கிறீர்கள்",
    likelyCountries: ["IN", "LK", "SG"]
  },
  {
    language: "ur",
    name: "乌尔都语",
    fonts: ["Nafees Nastaleeq", "Arial", "Tahoma"],
    text: "ہیلو دنیا آپ کیسے ہیں",
    likelyCountries: ["PK", "IN"]
  },
  {
    language: "th",
    name: "泰语",
    fonts: ["Tahoma", "Noto Sans Thai", "Arial"],
    text: "สวัสดีครับ วันนี้คุณเป็นอย่างไรบ้าง",
    likelyCountries: ["TH"]
  },
  {
    language: "vi",
    name: "越南语",
    fonts: ["Arial", "Tahoma", "Times New Roman"],
    text: "Chữ quốc ngữ rất đẹp và dễ học",
    likelyCountries: ["VN"]
  },
  {
    language: "id",
    name: "印尼语",
    fonts: ["Arial", "Verdana", "Georgia"],
    text: "Selamat pagi dunia bagaimana kabarmu",
    likelyCountries: ["ID"]
  },
  {
    language: "my",
    name: "缅甸语",
    fonts: ["Myanmar Text", "Noto Sans Myanmar", "Arial"],
    text: "မင်္ဂလာပါ ကမ္ဘာကြီး",
    likelyCountries: ["MM"]
  },
  {
    language: "sw",
    name: "斯瓦希里语",
    fonts: ["Arial", "Verdana", "Georgia"],
    text: "Habari dunia unajisikiaje leo",
    likelyCountries: ["KE", "TZ", "UG", "RW", "CD"]
  },
  {
    language: "am",
    name: "阿姆哈拉语",
    fonts: ["Nyala", "Noto Sans Ethiopic", "Arial"],
    text: "ሰላም ዓለም እንዴት",
    likelyCountries: ["ET"]
  }
];


    // ✅ 偏移量国家表（简化版）
const offsetInfoMap = {
  "-720": {
    countries: ["UM"],
    timeZone: "Etc/GMT+12",
    primaryCountry: "UM"
  },
  "-660": {
    countries: ["WS", "NU"],
    timeZone: "Pacific/Niue",
    primaryCountry: "NU"
  },
  "-600": {
    countries: ["PF", "TV", "KI"],
    timeZone: "Pacific/Tarawa",
    primaryCountry: "TV"
  },
  "-570": {
    countries: ["CK"],
    timeZone: "Pacific/Rarotonga",
    primaryCountry: "CK"
  },
  "-540": {
    countries: ["US", "MX"],
    timeZone: "America/Anchorage",
    primaryCountry: "US"
  },
  "-480": {
    countries: ["US", "CA"],
    timeZone: "America/Los_Angeles",
    primaryCountry: "US"
  },
  "-420": {
    countries: ["US", "CA"],
    timeZone: "America/Denver",
    primaryCountry: "US"
  },
  "-360": {
    countries: ["US", "MX", "CO", "PE"],
    timeZone: "America/Chicago",
    primaryCountry: "US"
  },
  "-300": {
    countries: ["US", "CU", "CO"],
    timeZone: "America/New_York",
    primaryCountry: "US"
  },
  "-240": {
    countries: ["VE", "DO"],
    timeZone: "America/Caracas",
    primaryCountry: "VE"
  },
  "-180": {
    countries: ["AR", "BR", "UY"],
    timeZone: "America/Argentina/Buenos_Aires",
    primaryCountry: "AR"
  },
  "-120": {
    countries: ["BR"],
    timeZone: "America/Noronha",
    primaryCountry: "BR"
  },
  "0": {
    countries: ["GB", "PT", "GH", "IS"],
    timeZone: "UTC",
    primaryCountry: "GB"
  },
  "60": {
    countries: ["FR", "DE", "IT", "ES", "SE", "NO", "PL", "CZ", "BE", "NL", "CH", "DK"],
    timeZone: "Europe/Berlin",
    primaryCountry: "DE"
  },
  "120": {
    countries: ["GR", "TR", "UA", "RO", "FI", "IL", "ZA"],
    timeZone: "Europe/Athens",
    primaryCountry: "GR"
  },
  "180": {
    countries: ["RU", "KE", "TZ", "IQ", "SA"],
    timeZone: "Europe/Moscow",
    primaryCountry: "RU"
  },
  "210": {
    countries: ["IR"],
    timeZone: "Asia/Tehran",
    primaryCountry: "IR"
  },
  "240": {
    countries: ["AE", "OM", "AZ"],
    timeZone: "Asia/Dubai",
    primaryCountry: "AE"
  },
  "270": {
    countries: ["AF"],
    timeZone: "Asia/Kabul",
    primaryCountry: "AF"
  },
  "300": {
    countries: ["PK", "UZ"],
    timeZone: "Asia/Karachi",
    primaryCountry: "PK"
  },
  "330": {
    countries: ["IN", "LK"],
    timeZone: "Asia/Kolkata",
    primaryCountry: "IN"
  },
  "345": {
    countries: ["NP"],
    timeZone: "Asia/Kathmandu",
    primaryCountry: "NP"
  },
  "360": {
    countries: ["BD", "KZ"],
    timeZone: "Asia/Dhaka",
    primaryCountry: "BD"
  },
  "390": {
    countries: ["MM"],
    timeZone: "Asia/Yangon",
    primaryCountry: "MM"
  },
  "420": {
    countries: ["TH", "ID", "VN", "KH"],
    timeZone: "Asia/Bangkok",
    primaryCountry: "TH"
  },
  "480": {
    countries: ["CN", "SG", "MY", "PH", "AU"],
    timeZone: "Asia/Shanghai",
    primaryCountry: "CN"
  },
  "525": {
    countries: ["AU"],
    timeZone: "Australia/Eucla",
    primaryCountry: "AU"
  },
  "540": {
    countries: ["JP", "KR"],
    timeZone: "Asia/Tokyo",
    primaryCountry: "JP"
  },
  "570": {
    countries: ["AU"],
    timeZone: "Australia/Adelaide",
    primaryCountry: "AU"
  },
  "600": {
    countries: ["AU", "PG", "FM"],
    timeZone: "Australia/Sydney",
    primaryCountry: "AU"
  },
  "660": {
    countries: ["NZ", "FJ", "TV"],
    timeZone: "Pacific/Auckland",
    primaryCountry: "NZ"
  },
  "720": {
    countries: ["KI"],
    timeZone: "Pacific/Kiritimati",
    primaryCountry: "KI"
  }
};


    // ✅ 国家支持语言表（简化版）
const countryLanguagesMap = {
  // 东亚与东南亚
  CN: ["zh-Hans"],
  TW: ["zh-Hant"],
  HK: ["zh-Hant", "en"],
  MO: ["zh-Hant", "pt"],
  SG: ["zh-Hans", "en", "ta", "ms"],
  MY: ["ms", "zh-Hans", "ta", "en"],
  JP: ["ja"],
  KR: ["ko"],
  VN: ["vi"],
  TH: ["th"],
  ID: ["id"],
  MM: ["my"],

  // 南亚
  IN: ["hi", "en", "ta", "bn", "ur"],
  PK: ["ur", "en"],
  BD: ["bn"],
  LK: ["ta", "si"],
  NP: ["ne"],
  AF: ["fa", "ps"],
  IR: ["fa"],

  // 中东与北非
  SA: ["ar"],
  AE: ["ar", "en"],
  EG: ["ar"],
  IQ: ["ar", "ku"],
  JO: ["ar"],
  LB: ["ar", "fr"],
  SY: ["ar"],
  MA: ["ar", "fr"],
  DZ: ["ar", "fr"],
  SD: ["ar"],

  // 欧洲
  RU: ["ru"],
  UA: ["uk", "ru"],
  BY: ["ru", "be"],
  KZ: ["ru", "kk"],
  PL: ["pl"],
  CZ: ["cs"],
  RO: ["ro"],
  HU: ["hu"],
  TR: ["tr"],
  GR: ["el"],
  CY: ["el", "tr"],
  DE: ["de"],
  AT: ["de"],
  CH: ["de", "fr", "it"],
  FR: ["fr"],
  BE: ["fr", "nl", "de"],
  NL: ["nl"],
  IT: ["it"],
  ES: ["es"],
  PT: ["pt"],
  GB: ["en"],
  IE: ["en", "ga"],
  FI: ["fi", "sv"],
  SE: ["sv"],
  NO: ["no"],
  DK: ["da"],
  LI: ["de"],

  // 美洲
  US: ["en", "es"],
  CA: ["en", "fr"],
  MX: ["es"],
  AR: ["es"],
  CO: ["es"],
  CL: ["es"],
  PE: ["es"],
  BR: ["pt"],
  SR: ["nl"],

  // 非洲
  KE: ["sw", "en"],
  TZ: ["sw", "en"],
  UG: ["sw", "en"],
  RW: ["rw", "sw", "en", "fr"],
  CD: ["fr", "sw"],
  AO: ["pt"],
  MZ: ["pt"],
  MG: ["fr"],
  SN: ["fr"],
  ET: ["am"],

  // 大洋洲
  AU: ["en"],
  NZ: ["en", "mi"],
  FJ: ["en", "hi"],
  PG: ["en"],
  MU: ["en", "fr", "hi"]
};


    // ✅ 字体渲染检测真实语言
    function detectRealLanguage() {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = 300;
      canvas.height = 100;

      const baseline = getFingerprint(ctx, "monospace", "测试");
      const candidates = [];

      for (const test of testCases) {
        let allFontsMatchBaseline = true;
        for (const font of test.fonts) {
          const fingerprint = getFingerprint(ctx, font, test.text);
          if (fingerprint !== baseline) {
            allFontsMatchBaseline = false;
            break;
          }
        }
        if (allFontsMatchBaseline) {
          candidates.push(test.language);
        }
      }

      return candidates.length > 0 ? candidates[0] : "unknown";
    }

    function getFingerprint(ctx, font, text) {
      ctx.clearRect(0, 0, 300, 100);
      ctx.font = `72px '${font}', monospace`;
      ctx.fillText(text, 10, 60);
      return canvasToHash(ctx.getImageData(0, 0, 300, 100).data);
    }

    function canvasToHash(data) {
      let hash = 0;
      for (let i = 0; i < data.length; i += 10) {
        hash = (hash << 5) - hash + data[i];
        hash |= 0;
      }
      return hash;
    }

    // ✅ 主检测逻辑
    window.onload = () => {
      const browserLang = navigator.language;
      const browserTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const offset = -new Date().getTimezoneOffset();
      const offsetStr = offset.toString();

      const offsetInfo = offsetInfoMap[offsetStr] || {};
      const offsetCountries = offsetInfo.countries || [];
      const detectedTimeZoneName = offsetInfo.timeZone || `UTC${offset >= 0 ? "+" : ""}${offset / 60}`;
      const detectedCountry = offsetInfo.primaryCountry || "unknown";

      const detectedLang = detectRealLanguage();
      const likelyCountries = testCases.find(t => t.language === detectedLang)?.likelyCountries || [];

      const intersection = offsetCountries.filter(c => likelyCountries.includes(c));
      const union = [...new Set([...offsetCountries, ...likelyCountries])];

      let bestGuess = intersection[0] || offsetCountries.find(c => {
        const langs = countryLanguagesMap[c] || [];
        return langs.includes(detectedLang);
      }) || likelyCountries[0] || "unknown";

      const confidence = intersection.length
        ? Math.round((intersection.length / union.length) * 100)
        : bestGuess !== "unknown" ? 50 : 0;

      const result = `
浏览器声明语言：${browserLang}
检测到的语言：${detectedLang}

浏览器声明时区：${browserTimeZone}
检测到的时区：${detectedTimeZoneName}
检测到的国家（基于时区）：${detectedCountry}

可能来自的国家："${bestGuess}"
置信度：${confidence}
`;

      document.getElementById("result").innerText = result;
    };
  </script>
</body>
</html>
